<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lumina ‚Äî Learn Programming Through Play</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: #F8F6F3;
      --bg-secondary: #EDE9E3;
      --surface: #FFFFFF;
      --border: #E2E8F0;
      --text-primary: #2D3748;
      --text-secondary: #64748B;
      --accent-purple: #667eea;
      --accent-green: #10B981;
      --accent-blue: #5B8DEF;
      --accent-pink: #EC4899;
      --accent-orange: #E8915A;
      --accent-teal: #4ABDB5;
    }
    
    body {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    
    .logo-text {
      font-size: 26px;
      font-weight: 800;
      color: white;
      letter-spacing: -0.5px;
    }
    
    .tagline {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    
    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 200px 1fr 360px;
      height: calc(100vh - 68px);
    }
    
    /* Toolbox */
    .toolbox {
      background: var(--surface);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 12px 0;
    }
    
    .category {
      margin-bottom: 4px;
    }
    
    .category-header {
      padding: 10px 14px;
      font-weight: 700;
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    
    .category-header:hover {
      background: #F8FAFC;
    }
    
    .category-arrow {
      margin-left: auto;
      font-size: 10px;
      transition: transform 0.2s;
    }
    
    .category.expanded .category-arrow {
      transform: rotate(90deg);
    }
    
    .category-blocks {
      padding: 4px 10px;
      display: none;
    }
    
    .category.expanded .category-blocks {
      display: block;
    }
    
    .block-template {
      padding: 9px 12px;
      margin: 4px 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: white;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .block-template:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Workspace */
    .workspace {
      display: flex;
      flex-direction: column;
      background: #FAFAF9;
    }
    
    .view-toggle {
      display: flex;
      padding: 10px 14px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    
    .toggle-btn {
      padding: 7px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      background: #F1F5F9;
      color: var(--text-secondary);
      transition: all 0.15s;
    }
    
    .toggle-btn.active {
      background: var(--accent-purple);
      color: white;
    }
    
    .code-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .editor {
      flex: 1;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      line-height: 1.6;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      color: var(--text-primary);
    }
    
    .editor::placeholder {
      color: #94A3B8;
    }
    
    .visual-view {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    
    .help-tip {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .code-preview {
      background: #F1F5F9;
      border-radius: 10px;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      color: var(--text-primary);
    }
    
    .run-bar {
      padding: 10px 14px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .run-btn {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 10px 28px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      transition: transform 0.15s, box-shadow 0.15s;
      font-family: inherit;
    }
    
    .run-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    .shortcut-hint {
      color: #94A3B8;
      font-size: 12px;
    }
    
    /* Right Panel */
    .right-panel {
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-section {
      border-bottom: 1px solid var(--border);
    }
    
    .panel-header {
      padding: 12px 14px;
      font-weight: 700;
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #F8FAFC;
      border-bottom: 1px solid var(--border);
    }
    
    .output {
      padding: 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      min-height: 50px;
      background: #1E293B;
      color: #E2E8F0;
      border-radius: 8px;
      margin: 10px;
    }
    
    .output.empty {
      color: #64748B;
    }
    
    .error {
      background: #FEE2E2;
      color: #DC2626;
      border-radius: 8px;
      padding: 12px 14px;
      margin: 10px;
      font-size: 13px;
    }
    
    .canvas-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .canvas-container {
      flex: 1;
      margin: 10px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: white;
      overflow: hidden;
    }
    
    #drawing-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .examples-section {
      max-height: 220px;
      display: flex;
      flex-direction: column;
    }
    
    .examples {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }
    
    .example-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      margin: 4px 0;
      background: #F8FAFC;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    
    .example-btn:hover {
      background: #EEF2FF;
      border-color: var(--accent-purple);
    }
    
    .example-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }
    
    .example-desc {
      font-size: 11px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">‚ú®</div>
      <span class="logo-text">Lumina</span>
    </div>
    <span class="tagline">Learn Programming Through Play</span>
  </header>
  
  <!-- Main Layout -->
  <main class="main">
    <!-- Toolbox -->
    <aside class="toolbox" id="toolbox"></aside>
    
    <!-- Workspace -->
    <section class="workspace">
      <div class="view-toggle">
        <button class="toggle-btn active" data-view="text">üìù Text</button>
        <button class="toggle-btn" data-view="visual">üß© Blocks</button>
        <button class="toggle-btn" data-view="both">‚ö° Both</button>
      </div>
      
      <div class="code-area" id="code-area">
        <textarea class="editor" id="editor" placeholder="Type your Lumina code here...

Try: (add 3 4)
Or: (draw-circle 150 150 50 blue)" spellcheck="false">(add 3 4)</textarea>
      </div>
      
      <div class="run-bar">
        <button class="run-btn" id="run-btn">‚ñ∂ Run</button>
        <span class="shortcut-hint">‚åò/Ctrl + Enter</span>
      </div>
    </section>
    
    <!-- Right Panel -->
    <aside class="right-panel">
      <div class="panel-section">
        <div class="panel-header">Output</div>
        <div id="output-container">
          <div class="output empty" id="output">Run your code to see the result</div>
        </div>
      </div>
      
      <div class="panel-section canvas-section">
        <div class="panel-header">Canvas</div>
        <div class="canvas-container">
          <canvas id="drawing-canvas"></canvas>
        </div>
      </div>
      
      <div class="panel-section examples-section">
        <div class="panel-header">Examples</div>
        <div class="examples" id="examples"></div>
      </div>
    </aside>
  </main>

  <script>
    // ========================================================================
    // LUMINA INTERPRETER
    // ========================================================================
    
    function tokenize(code) {
      const tokens = [];
      let i = 0;
      while (i < code.length) {
        let c = code[i];
        if (/\s/.test(c)) { i++; continue; }
        if (c === '(') { tokens.push({ type: 'LPAREN' }); i++; continue; }
        if (c === ')') { tokens.push({ type: 'RPAREN' }); i++; continue; }
        if (c === '"') {
          let v = ''; i++;
          while (i < code.length && code[i] !== '"') v += code[i++];
          i++; tokens.push({ type: 'STRING', value: v }); continue;
        }
        if (/[0-9]/.test(c) || (c === '-' && /[0-9]/.test(code[i+1]))) {
          let v = '';
          if (c === '-') { v += c; i++; }
          while (i < code.length && /[0-9.]/.test(code[i])) v += code[i++];
          tokens.push({ type: 'NUMBER', value: parseFloat(v) }); continue;
        }
        if (/[a-zA-Z_\-+*/<>=!?]/.test(c)) {
          let v = '';
          while (i < code.length && /[a-zA-Z0-9_\-+*/<>=!?]/.test(code[i])) v += code[i++];
          tokens.push({ type: 'SYMBOL', value: v }); continue;
        }
        if (c === "'") { tokens.push({ type: 'QUOTE' }); i++; continue; }
        throw new Error(`Unknown character: ${c}`);
      }
      return tokens;
    }
    
    function parse(tokens) {
      let i = 0;
      function parseExpr() {
        let t = tokens[i];
        if (t.type === 'QUOTE') { i++; return ['quote', parseExpr()]; }
        if (t.type === 'LPAREN') {
          i++; const list = [];
          while (tokens[i] && tokens[i].type !== 'RPAREN') list.push(parseExpr());
          if (!tokens[i]) throw new Error('Missing )');
          i++; return list;
        }
        if (t.type === 'NUMBER') { i++; return { type: 'number', value: t.value }; }
        if (t.type === 'STRING') { i++; return { type: 'string', value: t.value }; }
        if (t.type === 'SYMBOL') {
          i++;
          if (t.value === 'true') return { type: 'boolean', value: true };
          if (t.value === 'false') return { type: 'boolean', value: false };
          return { type: 'symbol', value: t.value };
        }
        throw new Error(`Unexpected: ${JSON.stringify(t)}`);
      }
      const exprs = [];
      while (i < tokens.length) exprs.push(parseExpr());
      return exprs;
    }
    
    function read(code) { return parse(tokenize(code)); }
    
    function print(e) {
      if (e == null) return 'nil';
      if (Array.isArray(e)) return '(' + e.map(print).join(' ') + ')';
      if (typeof e === 'object' && e.type) {
        switch (e.type) {
          case 'number': return String(e.value);
          case 'string': return `"${e.value}"`;
          case 'boolean': return e.value ? 'true' : 'false';
          case 'symbol': return e.value;
          case 'function': return `<function: ${e.name || 'Œª'}>`;
          case 'color': return `(color ${e.r} ${e.g} ${e.b})`;
          case 'list': return '(list ' + e.items.map(print).join(' ') + ')';
        }
      }
      return String(e);
    }
    
    function createEnv(parent = null) {
      const b = new Map();
      return {
        parent,
        define(n, v) { b.set(n, v); },
        lookup(n) {
          if (b.has(n)) return b.get(n);
          if (parent) return parent.lookup(n);
          throw new Error(`Unknown: ${n}`);
        }
      };
    }
    
    function evaluate(e, env, ctx) {
      if (typeof e === 'object' && e.type) {
        switch (e.type) {
          case 'number': case 'string': case 'boolean': case 'color': case 'list': return e;
          case 'symbol': return env.lookup(e.value);
        }
      }
      if (Array.isArray(e)) {
        if (e.length === 0) return { type: 'list', items: [] };
        const first = e[0];
        const op = first?.type === 'symbol' ? first.value : null;
        switch (op) {
          case 'quote': return e[1];
          case 'define':
            if (Array.isArray(e[1])) {
              const [n, ...p] = e[1].map(s => s.value);
              const f = { type: 'function', name: n, params: p, body: e[2], env };
              env.define(n, f); return f;
            } else {
              const n = e[1].value, v = evaluate(e[2], env, ctx);
              env.define(n, v); return v;
            }
          case 'if':
            const c = evaluate(e[1], env, ctx);
            return (c.type === 'boolean' ? c.value : true) ? evaluate(e[2], env, ctx) : evaluate(e[3], env, ctx);
          case 'lambda':
            return { type: 'function', name: null, params: e[1].map(s => s.value), body: e[2], env };
          case 'begin':
            let r = null;
            for (let i = 1; i < e.length; i++) r = evaluate(e[i], env, ctx);
            return r;
        }
        const func = evaluate(first, env, ctx);
        const args = e.slice(1).map(a => evaluate(a, env, ctx));
        if (typeof func === 'function') return func(args, ctx);
        if (func.type === 'function') {
          const fenv = createEnv(func.env);
          for (let i = 0; i < func.params.length; i++) fenv.define(func.params[i], args[i]);
          return evaluate(func.body, fenv, ctx);
        }
        throw new Error(`Cannot call: ${print(func)}`);
      }
      throw new Error(`Cannot evaluate: ${JSON.stringify(e)}`);
    }
    
    function createStdEnv() {
      const env = createEnv();
      const num = e => typeof e === 'number' ? e : e.value;
      const numR = n => ({ type: 'number', value: n });
      const boolR = b => ({ type: 'boolean', value: b });
      const strR = s => ({ type: 'string', value: s });
      
      env.define('add', a => numR(a.reduce((x, y) => num(x) + num(y), 0)));
      env.define('subtract', a => numR(a.length === 1 ? -num(a[0]) : num(a[0]) - num(a[1])));
      env.define('multiply', a => numR(a.reduce((x, y) => num(x) * num(y), 1)));
      env.define('divide', a => numR(num(a[0]) / num(a[1])));
      env.define('+', env.lookup('add'));
      env.define('-', env.lookup('subtract'));
      env.define('*', env.lookup('multiply'));
      env.define('/', env.lookup('divide'));
      
      env.define('equal?', a => boolR(num(a[0]) === num(a[1])));
      env.define('greater?', a => boolR(num(a[0]) > num(a[1])));
      env.define('less?', a => boolR(num(a[0]) < num(a[1])));
      env.define('=', env.lookup('equal?'));
      env.define('>', env.lookup('greater?'));
      env.define('<', env.lookup('less?'));
      
      env.define('and', a => boolR(a.every(x => x.value)));
      env.define('or', a => boolR(a.some(x => x.value)));
      env.define('not', a => boolR(!a[0].value));
      
      env.define('abs', a => numR(Math.abs(num(a[0]))));
      env.define('sqrt', a => numR(Math.sqrt(num(a[0]))));
      env.define('power', a => numR(Math.pow(num(a[0]), num(a[1]))));
      env.define('sin', a => numR(Math.sin(num(a[0]))));
      env.define('cos', a => numR(Math.cos(num(a[0]))));
      env.define('floor', a => numR(Math.floor(num(a[0]))));
      env.define('round', a => numR(Math.round(num(a[0]))));
      env.define('random', a => {
        if (a.length === 0) return numR(Math.random());
        if (a.length === 1) return numR(Math.floor(Math.random() * num(a[0])));
        return numR(Math.floor(Math.random() * (num(a[1]) - num(a[0]))) + num(a[0]));
      });
      env.define('pi', { type: 'number', value: Math.PI });
      
      env.define('color', a => ({ type: 'color', r: num(a[0]), g: num(a[1]), b: num(a[2]) }));
      env.define('rgb', env.lookup('color'));
      env.define('red', { type: 'color', r: 239, g: 68, b: 68 });
      env.define('green', { type: 'color', r: 34, g: 197, b: 94 });
      env.define('blue', { type: 'color', r: 59, g: 130, b: 246 });
      env.define('yellow', { type: 'color', r: 250, g: 204, b: 21 });
      env.define('purple', { type: 'color', r: 168, g: 85, b: 247 });
      env.define('orange', { type: 'color', r: 249, g: 115, b: 22 });
      env.define('pink', { type: 'color', r: 236, g: 72, b: 153 });
      env.define('white', { type: 'color', r: 255, g: 255, b: 255 });
      env.define('black', { type: 'color', r: 0, g: 0, b: 0 });
      env.define('gray', { type: 'color', r: 156, g: 163, b: 175 });
      
      env.define('list', a => ({ type: 'list', items: a }));
      env.define('first', a => {
        const l = a[0];
        if (l.type === 'list') return l.items[0];
        if (Array.isArray(l)) return l[0];
        throw new Error('Expected list');
      });
      env.define('rest', a => {
        const l = a[0];
        if (l.type === 'list') return { type: 'list', items: l.items.slice(1) };
        return l.slice(1);
      });
      env.define('second', a => (a[0].type === 'list' ? a[0].items : a[0])[1]);
      env.define('length', a => {
        const l = a[0];
        if (l.type === 'list') return numR(l.items.length);
        if (l.type === 'string') return numR(l.value.length);
        return numR(l.length);
      });
      env.define('empty?', a => {
        const l = a[0];
        if (l.type === 'list') return boolR(l.items.length === 0);
        return boolR(l.length === 0);
      });
      
      env.define('map', (a, ctx) => {
        const func = a[0];
        const list = a[1].type === 'list' ? a[1].items : a[1];
        const results = list.map(item => {
          if (typeof func === 'function') return func([item], ctx);
          const fenv = createEnv(func.env);
          fenv.define(func.params[0], item);
          return evaluate(func.body, fenv, ctx);
        });
        return { type: 'list', items: results };
      });
      
      env.define('filter', (a, ctx) => {
        const func = a[0];
        const list = a[1].type === 'list' ? a[1].items : a[1];
        const results = list.filter(item => {
          let r;
          if (typeof func === 'function') r = func([item], ctx);
          else {
            const fenv = createEnv(func.env);
            fenv.define(func.params[0], item);
            r = evaluate(func.body, fenv, ctx);
          }
          return r.type === 'boolean' ? r.value : true;
        });
        return { type: 'list', items: results };
      });
      
      env.define('range', a => {
        const start = a.length === 1 ? 0 : num(a[0]);
        const end = a.length === 1 ? num(a[0]) : num(a[1]);
        const items = [];
        for (let i = start; i < end; i++) items.push({ type: 'number', value: i });
        return { type: 'list', items };
      });
      
      env.define('concat', a => strR(a.map(x => x.type === 'string' ? x.value : String(x.value)).join('')));
      env.define('eval', (a, ctx) => evaluate(a[0], env, ctx));
      
      env.define('draw-circle', (a, ctx) => {
        if (!ctx) return strR('No canvas');
        ctx.addShape({ type: 'circle', x: num(a[0]), y: num(a[1]), radius: num(a[2]),
          color: a[3] ? `rgb(${a[3].r},${a[3].g},${a[3].b})` : '#5B8DEF' });
        return strR(`Circle at (${num(a[0])}, ${num(a[1])})`);
      });
      
      env.define('draw-rectangle', (a, ctx) => {
        if (!ctx) return strR('No canvas');
        ctx.addShape({ type: 'rectangle', x: num(a[0]), y: num(a[1]), width: num(a[2]), height: num(a[3]),
          color: a[4] ? `rgb(${a[4].r},${a[4].g},${a[4].b})` : '#5B8DEF' });
        return strR(`Rectangle`);
      });
      
      env.define('draw-line', (a, ctx) => {
        if (!ctx) return strR('No canvas');
        ctx.addShape({ type: 'line', x1: num(a[0]), y1: num(a[1]), x2: num(a[2]), y2: num(a[3]),
          color: a[4] ? `rgb(${a[4].r},${a[4].g},${a[4].b})` : '#5B8DEF' });
        return strR(`Line`);
      });
      
      env.define('draw-text', (a, ctx) => {
        if (!ctx) return strR('No canvas');
        const text = a[0].type === 'string' ? a[0].value : String(a[0].value);
        ctx.addShape({ type: 'text', text, x: num(a[1]), y: num(a[2]), size: a[3] ? num(a[3]) : 16,
          color: a[4] ? `rgb(${a[4].r},${a[4].g},${a[4].b})` : '#1a1a1a' });
        return strR(`Text: ${text}`);
      });
      
      env.define('clear', (a, ctx) => { if (ctx) ctx.clear(); return strR('Cleared'); });
      
      return env;
    }
    
    function runLumina(code, ctx) {
      try {
        const env = createStdEnv();
        const exprs = read(code);
        let result = null;
        for (const e of exprs) result = evaluate(e, env, ctx);
        return { success: true, result, output: print(result) };
      } catch (err) {
        return { success: false, error: err.message };
      }
    }
    
    // ========================================================================
    // BLOCK DEFINITIONS
    // ========================================================================
    
    const CATEGORIES = {
      numbers: { label: 'Numbers', icon: '123', color: '#5B8DEF',
        blocks: [
          { op: 'add', label: 'add' },
          { op: 'subtract', label: 'subtract' },
          { op: 'multiply', label: 'multiply' },
          { op: 'divide', label: 'divide' },
        ]
      },
      compare: { label: 'Compare', icon: '‚öñÔ∏è', color: '#9B8DC4',
        blocks: [
          { op: 'equal?', label: 'equal?' },
          { op: 'greater?', label: 'greater?' },
          { op: 'less?', label: 'less?' },
          { op: 'if', label: 'if' },
        ]
      },
      logic: { label: 'Logic', icon: 'üîÄ', color: '#E8915A',
        blocks: [
          { op: 'and', label: 'and' },
          { op: 'or', label: 'or' },
          { op: 'not', label: 'not' },
          { op: 'true', label: 'true' },
          { op: 'false', label: 'false' },
        ]
      },
      define: { label: 'Define', icon: 'üì¶', color: '#7BC47F',
        blocks: [
          { op: 'define-var', label: 'define' },
          { op: 'define-func', label: 'function' },
        ]
      },
      lists: { label: 'Lists', icon: 'üìã', color: '#4ABDB5',
        blocks: [
          { op: 'list', label: 'list' },
          { op: 'first', label: 'first' },
          { op: 'rest', label: 'rest' },
          { op: 'length', label: 'length' },
          { op: 'map', label: 'map' },
          { op: 'range', label: 'range' },
        ]
      },
      draw: { label: 'Draw', icon: 'üé®', color: '#EC4899',
        blocks: [
          { op: 'draw-circle', label: 'circle' },
          { op: 'draw-rectangle', label: 'rectangle' },
          { op: 'draw-line', label: 'line' },
          { op: 'draw-text', label: 'text' },
        ]
      },
      colors: { label: 'Colors', icon: 'üåà', color: '#F59E0B',
        blocks: [
          { op: 'red', label: 'red' },
          { op: 'blue', label: 'blue' },
          { op: 'green', label: 'green' },
          { op: 'yellow', label: 'yellow' },
          { op: 'purple', label: 'purple' },
          { op: 'color', label: 'rgb' },
        ]
      },
      math: { label: 'Math', icon: 'üìê', color: '#6366F1',
        blocks: [
          { op: 'sqrt', label: 'sqrt' },
          { op: 'power', label: 'power' },
          { op: 'sin', label: 'sin' },
          { op: 'cos', label: 'cos' },
          { op: 'random', label: 'random' },
          { op: 'pi', label: 'œÄ' },
        ]
      }
    };
    
    const TEMPLATES = {
      'add': '(add _ _)', 'subtract': '(subtract _ _)', 'multiply': '(multiply _ _)', 'divide': '(divide _ _)',
      'equal?': '(equal? _ _)', 'greater?': '(greater? _ _)', 'less?': '(less? _ _)', 'if': '(if condition then else)',
      'and': '(and _ _)', 'or': '(or _ _)', 'not': '(not _)', 'true': 'true', 'false': 'false',
      'define-var': '(define name value)', 'define-func': '(define (name x) body)',
      'list': '(list _ _ _)', 'first': '(first _)', 'rest': '(rest _)', 'length': '(length _)',
      'map': '(map function list)', 'range': '(range _)',
      'draw-circle': '(draw-circle x y radius)', 'draw-rectangle': '(draw-rectangle x y width height)',
      'draw-line': '(draw-line x1 y1 x2 y2)', 'draw-text': '(draw-text "text" x y)',
      'color': '(color r g b)', 'red': 'red', 'blue': 'blue', 'green': 'green', 'yellow': 'yellow', 'purple': 'purple',
      'sqrt': '(sqrt _)', 'power': '(power _ _)', 'sin': '(sin _)', 'cos': '(cos _)', 'random': '(random _)', 'pi': 'pi',
    };
    
    const EXAMPLES = [
      { name: 'üî¢ Simple Math', code: '(add 3 4)', desc: 'Add two numbers' },
      { name: 'üîÑ Nested Math', code: '(multiply 2 (add 3 4))', desc: 'Math inside math!' },
      { name: 'üì¶ Define a Name', code: '(define age 7)\n(add age 1)', desc: 'Save a number' },
      { name: '‚öôÔ∏è Make a Machine', code: '(define (double x)\n  (multiply x 2))\n\n(double 5)', desc: 'Create a function' },
      { name: 'üîµ Draw a Circle', code: '(draw-circle 150 100 50 blue)', desc: 'Draw a blue circle' },
      { name: 'üé® Colorful Circles', code: '(draw-circle 80 100 40 red)\n(draw-circle 170 100 40 green)\n(draw-circle 260 100 40 blue)', desc: 'Three colored circles' },
      { name: 'üìã Map Over List', code: '(define (double x)\n  (multiply x 2))\n\n(map double (list 1 2 3 4 5))', desc: 'Transform a list' },
      { name: 'üåÄ Pattern Art', code: '(map (lambda (i)\n  (draw-circle\n    (add 170 (multiply 80 (cos (multiply i 0.52))))\n    (add 100 (multiply 80 (sin (multiply i 0.52))))\n    12\n    (color (multiply i 25) 100 200)))\n(range 12))', desc: 'Circles in a pattern' },
      { name: 'üîç Code is Data!', code: '(define my-program\n  (quote (add 10 20)))\n\n(first my-program)', desc: 'Programs are lists!' },
    ];
    
    // ========================================================================
    // UI LOGIC
    // ========================================================================
    
    let currentView = 'text';
    let shapes = [];
    let expandedCategories = ['numbers', 'draw'];
    
    const editor = document.getElementById('editor');
    const output = document.getElementById('output');
    const outputContainer = document.getElementById('output-container');
    const canvas = document.getElementById('drawing-canvas');
    const ctx2d = canvas.getContext('2d');
    
    function initToolbox() {
      const toolbox = document.getElementById('toolbox');
      toolbox.innerHTML = '';
      
      for (const [key, cat] of Object.entries(CATEGORIES)) {
        const div = document.createElement('div');
        div.className = `category${expandedCategories.includes(key) ? ' expanded' : ''}`;
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<span>${cat.icon}</span><span>${cat.label}</span><span class="category-arrow">‚ñ∂</span>`;
        header.onclick = () => {
          if (expandedCategories.includes(key)) {
            expandedCategories = expandedCategories.filter(c => c !== key);
          } else {
            expandedCategories.push(key);
          }
          initToolbox();
        };
        
        const blocks = document.createElement('div');
        blocks.className = 'category-blocks';
        
        for (const block of cat.blocks) {
          const btn = document.createElement('div');
          btn.className = 'block-template';
          btn.style.background = cat.color;
          btn.textContent = block.label;
          btn.onclick = () => insertBlock(block.op);
          blocks.appendChild(btn);
        }
        
        div.appendChild(header);
        div.appendChild(blocks);
        toolbox.appendChild(div);
      }
    }
    
    function initExamples() {
      const container = document.getElementById('examples');
      container.innerHTML = '';
      
      for (const ex of EXAMPLES) {
        const btn = document.createElement('button');
        btn.className = 'example-btn';
        btn.innerHTML = `<div class="example-title">${ex.name}</div><div class="example-desc">${ex.desc}</div>`;
        btn.onclick = () => loadExample(ex);
        container.appendChild(btn);
      }
    }
    
    function insertBlock(op) {
      const template = TEMPLATES[op] || op;
      const current = editor.value;
      editor.value = current + (current ? '\n' : '') + template;
      editor.focus();
    }
    
    function loadExample(ex) {
      editor.value = ex.code;
      shapes = [];
      outputContainer.innerHTML = '<div class="output empty">Run your code to see the result</div>';
      drawCanvas();
    }
    
    function drawCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width * 2;
      canvas.height = rect.height * 2;
      ctx2d.scale(2, 2);
      
      ctx2d.fillStyle = 'white';
      ctx2d.fillRect(0, 0, rect.width, rect.height);
      
      for (const s of shapes) {
        ctx2d.fillStyle = s.color || '#5B8DEF';
        ctx2d.strokeStyle = s.color || '#5B8DEF';
        ctx2d.lineWidth = 2;
        
        switch (s.type) {
          case 'circle':
            ctx2d.beginPath();
            ctx2d.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
            ctx2d.fill();
            break;
          case 'rectangle':
            ctx2d.fillRect(s.x, s.y, s.width, s.height);
            break;
          case 'line':
            ctx2d.beginPath();
            ctx2d.moveTo(s.x1, s.y1);
            ctx2d.lineTo(s.x2, s.y2);
            ctx2d.stroke();
            break;
          case 'text':
            ctx2d.font = `${s.size || 16}px Nunito, sans-serif`;
            ctx2d.fillText(s.text, s.x, s.y);
            break;
        }
      }
    }
    
    function runCode() {
      shapes = [];
      const drawCtx = {
        addShape: s => shapes.push(s),
        clear: () => shapes.length = 0
      };
      
      const result = runLumina(editor.value, drawCtx);
      
      if (result.success) {
        outputContainer.innerHTML = `<div class="output">${result.output}</div>`;
      } else {
        outputContainer.innerHTML = `<div class="error">‚ö†Ô∏è ${result.error}</div>`;
      }
      
      drawCanvas();
    }
    
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      const codeArea = document.getElementById('code-area');
      
      if (view === 'visual') {
        codeArea.innerHTML = `
          <div class="visual-view">
            <div class="help-tip">üí° <strong>Tip:</strong> Click blocks in the toolbox to add them to your code. The visual block editor is coming soon!</div>
            <div class="code-preview">${editor.value || '(click a block to start)'}</div>
          </div>
        `;
      } else {
        codeArea.innerHTML = `<textarea class="editor" id="editor" placeholder="Type your Lumina code here..." spellcheck="false">${editor.value}</textarea>`;
      }
    }
    
    // Event Listeners
    document.getElementById('run-btn').onclick = runCode;
    
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.onclick = () => setView(btn.dataset.view);
    });
    
    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        runCode();
      }
    });
    
    window.addEventListener('resize', drawCanvas);
    
    // Initialize
    initToolbox();
    initExamples();
    setTimeout(drawCanvas, 100);
  </script>
</body>
</html>
