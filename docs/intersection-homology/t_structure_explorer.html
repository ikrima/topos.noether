<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>t-Structure Explorer: See the Heart Emerge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Charter', 'Georgia', serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            color: #e8e8e8;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 2px solid rgba(138, 180, 248, 0.3);
        }

        h1 {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #8ab4f8 0%, #c58af9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #aaa;
            font-style: italic;
        }

        .exploration-space {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(138, 180, 248, 0.2);
        }

        .panel h2 {
            color: #8ab4f8;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 400;
        }

        #categoryView {
            width: 100%;
            height: 500px;
            background: radial-gradient(ellipse at center, #1a1f2e 0%, #0f1419 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: move;
        }

        .control-group {
            margin-bottom: 2rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #8ab4f8;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .slider-container {
            position: relative;
            padding: 1rem 0;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(138, 180, 248, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8ab4f8 0%, #c58af9 100%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(138, 180, 248, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8ab4f8 0%, #c58af9 100%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(138, 180, 248, 0.5);
            border: none;
        }

        .degree-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #666;
        }

        .heart-indicator {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(197, 138, 249, 0.1);
            border: 2px solid #c58af9;
            border-radius: 8px;
            text-align: center;
        }

        .heart-indicator h3 {
            color: #c58af9;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .heart-formula {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .object-list {
            margin-top: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .object-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(138, 180, 248, 0.1);
            border-left: 3px solid #8ab4f8;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .object-item:hover {
            background: rgba(138, 180, 248, 0.2);
            transform: translateX(5px);
        }

        .object-item.in-heart {
            border-left-color: #c58af9;
            background: rgba(197, 138, 249, 0.15);
        }

        .object-name {
            font-weight: 600;
            color: #8ab4f8;
            margin-bottom: 0.5rem;
        }

        .object-item.in-heart .object-name {
            color: #c58af9;
        }

        .object-cohomology {
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: #aaa;
        }

        .insight-box {
            background: rgba(197, 138, 249, 0.05);
            border-left: 4px solid #c58af9;
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
        }

        .insight-box h3 {
            color: #c58af9;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .insight-box p {
            line-height: 1.8;
            color: #ccc;
        }

        .visualization-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .viz-button {
            flex: 1;
            padding: 0.75rem;
            background: rgba(138, 180, 248, 0.1);
            border: 1px solid rgba(138, 180, 248, 0.3);
            border-radius: 6px;
            color: #8ab4f8;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .viz-button:hover {
            background: rgba(138, 180, 248, 0.2);
            transform: translateY(-2px);
        }

        .viz-button.active {
            background: rgba(138, 180, 248, 0.3);
            border-color: #8ab4f8;
        }

        canvas {
            display: block;
        }

        .morphism-path {
            stroke: #8ab4f8;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .morphism-path:hover {
            stroke: #c58af9;
            stroke-width: 3;
            opacity: 1;
        }

        .cohomology-indicator {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(138, 180, 248, 0.05);
            border-radius: 6px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        .degree-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            background: rgba(138, 180, 248, 0.2);
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .degree-badge.nonzero {
            background: rgba(197, 138, 249, 0.3);
            color: #c58af9;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .pulsing {
            animation: pulse 2s ease-in-out infinite;
        }

        .formula-explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #bbb;
        }

        .interactive-hint {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(197, 138, 249, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #c58af9;
            opacity: 0;
            animation: fadeInOut 4s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>The t-Structure: A Living Cathedral</h1>
            <p class="subtitle">Watch the heart of the perverse t-structure emerge from your hands</p>
        </header>

        <div class="insight-box">
            <h3>Emily Riehl's Insight</h3>
            <p>
                A t-structure is a way to do <em>homological algebra inside a triangulated category</em>. 
                The perverse t-structure on D<sup>b</sup><sub>c</sub>(X) tells us which objects are 
                "concentrated in degree 0" from the perverse perspective. The intersection 
                D<sup>‚â§0</sup> ‚à© D<sup>‚â•0</sup> is the <strong>heart</strong>‚Äîan abelian category 
                of perverse sheaves. Move the sliders below and <em>see</em> the heart emerge.
            </p>
        </div>

        <div class="exploration-space">
            <div class="panel">
                <h2>Truncation Control</h2>
                
                <div class="control-group">
                    <label>Lower Truncation œÑ<sup>‚â§n</sup></label>
                    <div class="slider-container">
                        <input type="range" id="lowerTrunc" min="-5" max="5" value="-2" step="1">
                        <div class="degree-labels">
                            <span>‚àí5</span>
                            <span>‚àí2</span>
                            <span>0</span>
                            <span>2</span>
                            <span>5</span>
                        </div>
                    </div>
                    <div class="formula-explanation">
                        œÑ<sup>‚â§n</sup> kills cohomology sheaves in degrees above n. 
                        <span id="lowerTruncValue">n = -2</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Upper Truncation œÑ<sup>‚â•n</sup></label>
                    <div class="slider-container">
                        <input type="range" id="upperTrunc" min="-5" max="5" value="2" step="1">
                        <div class="degree-labels">
                            <span>‚àí5</span>
                            <span>‚àí2</span>
                            <span>0</span>
                            <span>2</span>
                            <span>5</span>
                        </div>
                    </div>
                    <div class="formula-explanation">
                        œÑ<sup>‚â•n</sup> kills cohomology sheaves in degrees below n.
                        <span id="upperTruncValue">n = 2</span>
                    </div>
                </div>

                <div class="heart-indicator">
                    <h3>The Heart</h3>
                    <div class="heart-formula">
                        Perv(X) = D<sup>‚â§<span id="heartLower">-2</span></sup> ‚à© D<sup>‚â•<span id="heartUpper">2</span></sup>
                    </div>
                    <div class="cohomology-indicator">
                        Objects with cohomology only in degrees: 
                        <span id="heartDegrees" class="pulsing"></span>
                    </div>
                </div>

                <div class="visualization-controls">
                    <button class="viz-button active" data-mode="category">Category View</button>
                    <button class="viz-button" data-mode="filtration">Filtration View</button>
                    <button class="viz-button" data-mode="spectral">Spectral View</button>
                </div>
            </div>

            <div class="panel">
                <h2>The Derived Category D<sup>b</sup><sub>c</sub>(X)</h2>
                <div id="categoryView">
                    <canvas id="categoryCanvas"></canvas>
                    <div class="interactive-hint">Drag to explore ‚Ä¢ Scroll to zoom</div>
                </div>
                <div class="cohomology-indicator">
                    <div><strong>Legend:</strong></div>
                    <span class="degree-badge">D<sup>‚â§0</sup></span>
                    <span class="degree-badge">D<sup>‚â•0</sup></span>
                    <span class="degree-badge nonzero">Heart (perverse)</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Objects in View</h2>
            <div class="object-list" id="objectList"></div>
        </div>

        <div class="insight-box">
            <h3>Bret Victor's Perspective</h3>
            <p>
                Don't just <em>read</em> about t-structures‚Äî<strong>feel</strong> them. 
                Adjust the truncations and watch which objects stay in view. The perverse sheaves 
                aren't hiding in abstract nonsense‚Äîthey're the objects that survive <em>both</em> 
                truncations simultaneously. This is how mathematical intuition is built: through 
                your hands, into your eyes, into your understanding.
            </p>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        
        const state = {
            lowerTrunc: -2,
            upperTrunc: 2,
            viewMode: 'category',
            objects: [],
            camera: { x: 0, y: 0, zoom: 1 },
            mouse: { down: false, x: 0, y: 0 }
        };

        // ============================================================================
        // MATHEMATICAL OBJECTS
        // ============================================================================

        class DerivedObject {
            constructor(name, cohomology, pos) {
                this.name = name;
                this.cohomology = cohomology; // Map: degree -> dimension
                this.pos = pos;
            }

            isInDLeq(n) {
                // Check dim Supp(H^i) <= -i for i > n
                for (let [deg, dim] of Object.entries(this.cohomology)) {
                    if (parseInt(deg) > n && dim > 0) return false;
                }
                return true;
            }

            isInDGeq(n) {
                // Check dim Supp(H^i) <= -i for i < n
                for (let [deg, dim] of Object.entries(this.cohomology)) {
                    if (parseInt(deg) < n && dim > 0) return false;
                }
                return true;
            }

            isInHeart(lower, upper) {
                return this.isInDLeq(lower) && this.isInDGeq(upper);
            }

            nonzeroDegrees() {
                return Object.entries(this.cohomology)
                    .filter(([_, dim]) => dim > 0)
                    .map(([deg, _]) => parseInt(deg));
            }
        }

        // Initialize objects in the derived category
        function createExampleObjects() {
            return [
                new DerivedObject('‚Ñö_X[0]', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.2, y: 0.5}),
                new DerivedObject('‚Ñö_X[1]', {'-2': 0, '-1': 1, '0': 0, '1': 0, '2': 0}, {x: 0.3, y: 0.3}),
                new DerivedObject('‚Ñö_X[2]', {'-2': 1, '-1': 0, '0': 0, '1': 0, '2': 0}, {x: 0.4, y: 0.7}),
                new DerivedObject('IC_X', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.5, y: 0.5}),
                new DerivedObject('F‚Ä¢[‚àí1]', {'-3': 0, '-2': 0, '-1': 1, '0': 1, '1': 0}, {x: 0.6, y: 0.4}),
                new DerivedObject('G‚Ä¢[1]', {'-1': 0, '0': 1, '1': 1, '2': 0, '3': 0}, {x: 0.7, y: 0.6}),
                new DerivedObject('H‚Ä¢', {'-2': 1, '-1': 1, '0': 1, '1': 1, '2': 1}, {x: 0.8, y: 0.5}),
                new DerivedObject('j_!‚Ñö_U', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.25, y: 0.7}),
                new DerivedObject('j_*‚Ñö_U', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.35, y: 0.3}),
                new DerivedObject('Cone(f)', {'-1': 1, '0': 1, '1': 0, '2': 0}, {x: 0.55, y: 0.7}),
                new DerivedObject('‚Ñö_S[0]', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.65, y: 0.3}),
                new DerivedObject('ùîªIC_X', {'-2': 0, '-1': 0, '0': 1, '1': 0, '2': 0}, {x: 0.75, y: 0.5}),
            ];
        }

        state.objects = createExampleObjects();

        // ============================================================================
        // CANVAS RENDERING
        // ============================================================================

        const canvas = document.getElementById('categoryCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('categoryView');

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            render();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function render() {
            const w = canvas.width;
            const h = canvas.height;

            // Clear
            ctx.fillStyle = '#0f1419';
            ctx.fillRect(0, 0, w, h);

            // Draw grid
            ctx.strokeStyle = 'rgba(138, 180, 248, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo((i / 10) * w, 0);
                ctx.lineTo((i / 10) * w, h);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, (i / 10) * h);
                ctx.lineTo(w, (i / 10) * h);
                ctx.stroke();
            }

            // Draw degree bands
            const centerY = h / 2;
            const degreeHeight = h / 10;

            for (let deg = -5; deg <= 5; deg++) {
                const y = centerY - deg * degreeHeight;
                
                // Highlight if in range
                const inLower = deg <= state.lowerTrunc;
                const inUpper = deg >= state.upperTrunc;
                const inHeart = inLower && inUpper;

                if (inHeart) {
                    ctx.fillStyle = 'rgba(197, 138, 249, 0.15)';
                    ctx.fillRect(0, y - degreeHeight/2, w, degreeHeight);
                } else if (inLower || inUpper) {
                    ctx.fillStyle = 'rgba(138, 180, 248, 0.05)';
                    ctx.fillRect(0, y - degreeHeight/2, w, degreeHeight);
                }

                // Degree label
                ctx.fillStyle = inHeart ? '#c58af9' : 'rgba(138, 180, 248, 0.5)';
                ctx.font = '12px Fira Code, monospace';
                ctx.fillText(`deg ${deg}`, 10, y + 4);
            }

            // Draw objects
            state.objects.forEach(obj => {
                const x = obj.pos.x * w;
                const baseY = centerY;

                // Determine position based on cohomology
                const degrees = obj.nonzeroDegrees();
                if (degrees.length === 0) return;
                
                const avgDeg = degrees.reduce((a, b) => a + b, 0) / degrees.length;
                const y = baseY - avgDeg * degreeHeight;

                const inHeart = obj.isInHeart(state.lowerTrunc, state.upperTrunc);
                const inDLeq = obj.isInDLeq(state.lowerTrunc);
                const inDGeq = obj.isInDGeq(state.upperTrunc);

                // Object circle
                ctx.beginPath();
                ctx.arc(x, y, inHeart ? 20 : 15, 0, Math.PI * 2);
                
                if (inHeart) {
                    ctx.fillStyle = 'rgba(197, 138, 249, 0.3)';
                    ctx.strokeStyle = '#c58af9';
                    ctx.lineWidth = 3;
                } else if (inDLeq || inDGeq) {
                    ctx.fillStyle = 'rgba(138, 180, 248, 0.2)';
                    ctx.strokeStyle = '#8ab4f8';
                    ctx.lineWidth = 2;
                } else {
                    ctx.fillStyle = 'rgba(138, 180, 248, 0.1)';
                    ctx.strokeStyle = 'rgba(138, 180, 248, 0.3)';
                    ctx.lineWidth = 1;
                }
                
                ctx.fill();
                ctx.stroke();

                // Object label
                ctx.fillStyle = inHeart ? '#c58af9' : '#8ab4f8';
                ctx.font = 'bold 11px Fira Code, monospace';
                ctx.textAlign = 'center';
                ctx.fillText(obj.name, x, y - 25);

                // Cohomology indicators (small dots)
                degrees.forEach((deg, i) => {
                    const dotY = baseY - deg * degreeHeight;
                    ctx.beginPath();
                    ctx.arc(x + (i - degrees.length/2 + 0.5) * 8, dotY, 3, 0, Math.PI * 2);
                    ctx.fillStyle = inHeart ? '#c58af9' : '#8ab4f8';
                    ctx.fill();
                });
            });

            // Draw truncation boundaries
            const lowerY = centerY - state.lowerTrunc * degreeHeight;
            const upperY = centerY - state.upperTrunc * degreeHeight;

            ctx.strokeStyle = '#8ab4f8';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, lowerY);
            ctx.lineTo(w, lowerY);
            ctx.stroke();

            ctx.strokeStyle = '#c58af9';
            ctx.beginPath();
            ctx.moveTo(0, upperY);
            ctx.lineTo(w, upperY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Labels
            ctx.fillStyle = '#8ab4f8';
            ctx.font = '14px Fira Code, monospace';
            ctx.textAlign = 'right';
            ctx.fillText(`œÑ‚â§${state.lowerTrunc}`, w - 10, lowerY - 10);
            
            ctx.fillStyle = '#c58af9';
            ctx.fillText(`œÑ‚â•${state.upperTrunc}`, w - 10, upperY + 20);
        }

        // ============================================================================
        // INTERACTION
        // ============================================================================

        document.getElementById('lowerTrunc').addEventListener('input', (e) => {
            state.lowerTrunc = parseInt(e.target.value);
            updateUI();
        });

        document.getElementById('upperTrunc').addEventListener('input', (e) => {
            state.upperTrunc = parseInt(e.target.value);
            updateUI();
        });

        document.querySelectorAll('.viz-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.viz-button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.viewMode = e.target.dataset.mode;
                render();
            });
        });

        // Canvas interaction
        canvas.addEventListener('mousedown', (e) => {
            state.mouse.down = true;
            state.mouse.x = e.clientX;
            state.mouse.y = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (state.mouse.down) {
                const dx = e.clientX - state.mouse.x;
                const dy = e.clientY - state.mouse.y;
                state.camera.x += dx;
                state.camera.y += dy;
                state.mouse.x = e.clientX;
                state.mouse.y = e.clientY;
                render();
            }
        });

        canvas.addEventListener('mouseup', () => {
            state.mouse.down = false;
        });

        // ============================================================================
        // UI UPDATE
        // ============================================================================

        function updateUI() {
            // Update value displays
            document.getElementById('lowerTruncValue').textContent = `n = ${state.lowerTrunc}`;
            document.getElementById('upperTruncValue').textContent = `n = ${state.upperTrunc}`;
            document.getElementById('heartLower').textContent = state.lowerTrunc;
            document.getElementById('heartUpper').textContent = state.upperTrunc;

            // Heart degrees
            const heartDegrees = [];
            for (let d = state.upperTrunc; d <= state.lowerTrunc; d++) {
                heartDegrees.push(d);
            }
            
            const degreesHTML = heartDegrees.length > 0 
                ? heartDegrees.map(d => `<span class="degree-badge nonzero">${d}</span>`).join('')
                : '<span class="degree-badge">‚àÖ (empty heart)</span>';
            
            document.getElementById('heartDegrees').innerHTML = degreesHTML;

            // Object list
            const objectList = document.getElementById('objectList');
            objectList.innerHTML = '';

            state.objects.forEach(obj => {
                const inHeart = obj.isInHeart(state.lowerTrunc, state.upperTrunc);
                const degrees = obj.nonzeroDegrees();
                
                const item = document.createElement('div');
                item.className = 'object-item' + (inHeart ? ' in-heart' : '');
                
                const degreesStr = degrees.map(d => `H^${d}`).join(', ') || 'none';
                
                item.innerHTML = `
                    <div class="object-name">${obj.name}</div>
                    <div class="object-cohomology">
                        Nonzero cohomology: ${degreesStr}
                    </div>
                    ${inHeart ? '<div style="color: #c58af9; margin-top: 0.5rem;">‚úì In heart (perverse)</div>' : ''}
                `;
                
                objectList.appendChild(item);
            });

            render();
        }

        // Initial render
        updateUI();

        // ============================================================================
        // ANIMATION LOOP
        // ============================================================================

        function animate() {
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
