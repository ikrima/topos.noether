<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intersection Cohomology Workshop</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #1e293b; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .canvas-container {
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons (Internal) ---
        const Icon = ({ name, size=24, className }) => {
            const icons = {
                Play: <polygon points="5 3 19 12 5 21 5 3"></polygon>,
                Pause: <rect x="6" y="4" width="4" height="16"></rect>,
                RefreshCw: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>,
                Scissors: <><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></>,
                ArrowDown: <><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></>,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>,
                Trash2: <><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- Particle System Logic ---
        class ParticleSystem {
            constructor(width, height) {
                this.width = width;
                this.height = height;
                this.particles = [];
                this.tipData = []; // Accumulated data at the singularity
                this.mode = 'j_shriek'; // 'j_shriek' (!), 'j_star' (*), 'j_inter' (!*)
                this.frameCount = 0;
            }

            // Create a new particle at the top (Rim)
            spawn() {
                // Type 0: Invariant Cycle (Good data, should pass) - BLUE
                // Type 1: Vanishing Cycle (Bad data, should vanish) - RED
                const type = Math.random() > 0.5 ? 0 : 1;

                this.particles.push({
                    x: Math.random() * this.width,
                    y: 0,
                    vx: (this.width / 2 - (Math.random() * this.width)) * 0.01, // Drift towards center
                    vy: 2 + Math.random(),
                    type: type,
                    life: 1.0,
                    state: 'flowing' // flowing, stuck, passed
                });
            }

            update() {
                const centerX = this.width / 2;
                const tipY = this.height - 50;

                // 1. Spawn new data
                if (this.frameCount % 5 === 0) this.spawn();

                // 2. Update particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];

                    if (p.state === 'flowing') {
                        // Move towards the tip (conical flow)
                        const dx = centerX - p.x;
                        const dy = tipY - p.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);

                        p.vx += dx * 0.001; // Attraction to axis
                        p.x += p.vx;
                        p.y += p.vy;

                        // Check interactions based on mode
                        if (p.y > tipY - 20) {
                            this.handleSingularityInteraction(p, i);
                        }
                    } else if (p.state === 'stuck') {
                        // Jiggle in place (chaos)
                        p.x += (Math.random() - 0.5) * 2;
                        p.y += (Math.random() - 0.5) * 2;
                        p.life -= 0.01;
                        if (p.life <= 0) this.particles.splice(i, 1);
                    } else if (p.state === 'passed') {
                        p.y += 4; // Flow away fast
                        p.life -= 0.02;
                        if (p.life <= 0) this.particles.splice(i, 1);
                    }
                }

                this.frameCount++;
            }

            handleSingularityInteraction(p, index) {
                if (this.mode === 'j_shriek') {
                    // EXTENSION BY ZERO (j!)
                    // Hard stop. "Cliff".
                    // Particles hit an invisible wall and die or bounce.
                    p.state = 'stuck';
                    p.vy = -p.vy * 0.5; // Bounce back slightly
                    p.life = 0.5; // Die quickly
                }
                else if (this.mode === 'j_star') {
                    // PUSHFORWARD (j*)
                    // Everything accumulates.
                    // Both Red and Blue particles pile up.
                    p.state = 'stuck';
                    p.life = 2.0; // Persist longer (clutter)
                }
                else if (this.mode === 'j_inter') {
                    // INTERMEDIATE EXTENSION (j!*)
                    // The Filter.
                    // Blue (Invariant) passes. Red (Vanishing) is destroyed.
                    if (p.type === 0) {
                        p.state = 'passed'; // Success!
                    } else {
                        // Smoothly fades out (filtered)
                        this.particles.splice(index, 1);
                    }
                }
            }
        }

        // --- Main Component ---
        const App = () => {
            const canvasRef = useRef(null);
            const [mode, setMode] = useState('j_shriek');
            const systemRef = useRef(new ParticleSystem(600, 400));
            const requestRef = useRef();

            const modes = {
                j_shriek: {
                    title: "Extension by Zero (j!)",
                    desc: "Data hits a cliff. The stalk at the singularity is zero. Information is lost abruptly.",
                    icon: "Trash2",
                    color: "text-red-600",
                    bg: "bg-red-50",
                    border: "border-red-200"
                },
                j_star: {
                    title: "Standard Pushforward (j*)",
                    desc: "The dam breaks. All local data—invariants AND coinvariants—piles up at the singularity. It's too messy.",
                    icon: "ArrowDown",
                    color: "text-amber-600",
                    bg: "bg-amber-50",
                    border: "border-amber-200"
                },
                j_inter: {
                    title: "Intermediate Extension (j!*)",
                    desc: "The Goresky-MacPherson Fix. We identify the 'extendable' data (blue) and filter out the 'vanishing' data (red). Smooth flow.",
                    icon: "Shield",
                    color: "text-indigo-600",
                    bg: "bg-indigo-50",
                    border: "border-indigo-200"
                }
            };

            // Animation Loop
            const animate = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const sys = systemRef.current;

                sys.width = canvas.width;
                sys.height = canvas.height;
                sys.mode = mode;

                // Update Physics
                sys.update();

                // --- Draw ---
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. Draw Cone Geometry (Schematic)
                const cx = canvas.width / 2;
                const tipY = canvas.height - 50;

                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(cx, tipY); // Left wall
                ctx.lineTo(canvas.width, 0); // Right wall
                ctx.strokeStyle = '#cbd5e1';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Cone Fill
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, 'rgba(241, 245, 249, 0)');
                grad.addColorStop(1, 'rgba(241, 245, 249, 0.5)');
                ctx.fillStyle = grad;
                ctx.fill();

                // 2. Draw Singularity (The Tip)
                ctx.beginPath();
                ctx.arc(cx, tipY, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#1e293b';
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText("0", cx - 4, tipY + 4);

                // 3. Draw "Filter" Visuals based on mode
                if (mode === 'j_shriek') {
                    // Draw a "Wall"
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(cx - 30, tipY - 20);
                    ctx.lineTo(cx + 30, tipY - 20);
                    ctx.stroke();
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText("BARRIER", cx + 35, tipY - 16);
                } else if (mode === 'j_inter') {
                    // Draw a "Filter Gate"
                    ctx.strokeStyle = '#4f46e5';
                    ctx.setLineDash([5, 3]);
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(cx, tipY - 20, 20, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.fillStyle = '#4f46e5';
                    ctx.fillText("FILTER", cx + 25, tipY - 16);
                }

                // 4. Draw Particles
                sys.particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    // Blue = Invariant (Good), Red = Vanishing (Bad)
                    ctx.fillStyle = p.type === 0 ? '#3b82f6' : '#ef4444';
                    ctx.globalAlpha = p.life;
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                });

                requestRef.current = requestAnimationFrame(animate);
            };

            useEffect(() => {
                requestRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(requestRef.current);
            }, [mode]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

                    {/* Header */}
                    <div className="max-w-4xl w-full mb-8 text-center">
                        <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight mb-2">
                            Intersection Cohomology Workshop
                        </h1>
                        <p className="text-slate-500 max-w-2xl mx-auto">
                            "Singularities are not errors; they are features. But we must choose how we listen to them."
                            <br/>
                            <span className="text-xs uppercase tracking-wide font-bold mt-2 inline-block text-slate-400">— The Perverse Sheaves Manifesto</span>
                        </p>
                    </div>

                    {/* Main Interactive Area */}
                    <div className="bg-white rounded-2xl shadow-xl overflow-hidden max-w-5xl w-full flex flex-col md:flex-row border border-slate-200">

                        {/* Simulation Viewport */}
                        <div className="relative flex-1 bg-slate-50 canvas-container min-h-[400px]">
                            <canvas
                                ref={canvasRef}
                                width={600}
                                height={400}
                                className="w-full h-full object-contain"
                            />

                            {/* Legend Overlay */}
                            <div className="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-2 rounded-lg border border-slate-200 text-xs shadow-sm">
                                <div className="font-bold text-slate-600 mb-1">Local System Data ($L$)</div>
                                <div className="flex items-center gap-2 mb-1">
                                    <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span>Invariant Cycles (Extendable)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                    <span>Vanishing Cycles (Noise)</span>
                                </div>
                            </div>
                        </div>

                        {/* Controls Sidebar */}
                        <div className="w-full md:w-80 bg-white border-l border-slate-100 flex flex-col">
                            <div className="p-6 border-b border-slate-100">
                                <h2 className="font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="Scissors" size={20} className="text-slate-400" />
                                    Select Extension Tool
                                </h2>
                                <p className="text-xs text-slate-500 mt-1">
                                    How should we extend the sheaf $L$ across the singularity $0$?
                                </p>
                            </div>

                            <div className="flex-1 p-6 space-y-4 overflow-y-auto">

                                {/* Button: j! */}
                                <button
                                    onClick={() => setMode('j_shriek')}
                                    className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 group relative
                                        ${mode === 'j_shriek'
                                            ? 'border-red-500 bg-red-50 shadow-md scale-[1.02]'
                                            : 'border-slate-100 hover:border-red-200 hover:bg-slate-50'}`}
                                >
                                    <div className="flex items-start gap-3">
                                        <div className={`p-2 rounded-lg ${mode === 'j_shriek' ? 'bg-red-200 text-red-700' : 'bg-slate-100 text-slate-400'}`}>
                                            <span className="mono font-bold text-lg">j<sub className="align-middle">!</sub></span>
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800 group-hover:text-red-700">Extension by Zero</div>
                                            <div className="text-xs text-slate-500 mt-1 leading-relaxed">
                                                Stalk at 0 is zero. Creates a topological "cliff". Data bounces off.
                                            </div>
                                        </div>
                                    </div>
                                </button>

                                {/* Button: j* */}
                                <button
                                    onClick={() => setMode('j_star')}
                                    className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 group relative
                                        ${mode === 'j_star'
                                            ? 'border-amber-500 bg-amber-50 shadow-md scale-[1.02]'
                                            : 'border-slate-100 hover:border-amber-200 hover:bg-slate-50'}`}
                                >
                                    <div className="flex items-start gap-3">
                                        <div className={`p-2 rounded-lg ${mode === 'j_star' ? 'bg-amber-200 text-amber-800' : 'bg-slate-100 text-slate-400'}`}>
                                            <span className="mono font-bold text-lg">j<sub className="align-middle">*</sub></span>
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800 group-hover:text-amber-700">Standard Pushforward</div>
                                            <div className="text-xs text-slate-500 mt-1 leading-relaxed">
                                                Stalk at 0 is everything. The "dam breaks". The singularity becomes cluttered.
                                            </div>
                                        </div>
                                    </div>
                                </button>

                                {/* Button: j!* */}
                                <button
                                    onClick={() => setMode('j_inter')}
                                    className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 group relative
                                        ${mode === 'j_inter'
                                            ? 'border-indigo-500 bg-indigo-50 shadow-md scale-[1.02]'
                                            : 'border-slate-100 hover:border-indigo-200 hover:bg-slate-50'}`}
                                >
                                    <div className="flex items-start gap-3">
                                        <div className={`p-2 rounded-lg ${mode === 'j_inter' ? 'bg-indigo-200 text-indigo-700' : 'bg-slate-100 text-slate-400'}`}>
                                            <span className="mono font-bold text-lg">j<sub className="align-middle">!*</sub></span>
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800 group-hover:text-indigo-700">Intermediate Extension</div>
                                            <div className="text-xs text-slate-500 mt-1 leading-relaxed">
                                                The "Smart Filter". Keeps invariant cycles (blue), discards vanishing cycles (red).
                                                <span className="block mt-1 font-semibold text-indigo-600">This is the Intersection Cohomology.</span>
                                            </div>
                                        </div>
                                    </div>
                                </button>

                            </div>

                            {/* Status Bar */}
                            <div className={`p-4 border-t ${modes[mode].bg} ${modes[mode].color} text-sm font-medium flex items-center gap-2`}>
                                <Icon name="Activity" size={16} />
                                <span>Current Stalk Status: {mode === 'j_shriek' ? 'ZERO (Cliff)' : mode === 'j_star' ? 'FULL (Chaos)' : 'IMAGE (Smooth)'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
